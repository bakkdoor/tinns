#!/bin/bash
#
###########################################################
# setsvnrev script for TinNS. Original written by Hammag, #
# improved by Namikon.                                    #
# See bottom of file for GPL license.                     #
###########################################################
#                                                         #
# Last edited: 08.01.2076 18:02 GMT +1 by Hammag          #
#                                                         #
###########################################################
# How this works:                                         #
#    Everytime you do "make", this script is called.      #
#    It will check the current svn headerfile if its      #
#    a new revision or just a recompile.                  #
#    IF it is a new revision, the script tries to get     #
#    the actual version from the official SVN             #
#    tool "svnversion". If your server has no SVN         #
#    installed (which is not good if you want to          #
#    participate in TinNS dev), or it is outdated for     #
#    some reason, you must manually update svnrev.h       #
#    This number is then written to svnrev.h, compiled    #
#    into Patch, Info and Gameserver, and can be viewed   #
#    ingame by typing @version                            #
###########################################################

if [[ $# -ne 2 ]]; then
	echo "Error - usage:" `basename $0` "<svn base path> <svnrev.h filepath>" >&2
	exit -1
fi

#We exit silently if no SVN system seem to be used locally
if [[ ! -d $1/.svn ]]; then exit 0; fi
 
v=`svnversion $1`
if [[ $? -ne 0 ]]; then
	echo "###### WARNING : can't get SVN revision number ######"
	echo " You must manually update rev number in include/version.h before any public release !"
	if [[ ! -f .no_msg_stop ]]; then
		echo
		echo ---- Press a key to continue ----
                read -s -n 1
		touch .no_msg_stop
	fi
	exit 0
fi
#if expr "$v" : '[0-9]\+$' > /dev/null; then
	current=`echo $v | sed 's/^\([0-9]*:\)\?\([0-9]\+\)[^0-9]*/\2/'`
	modif=`echo $v | sed 's/^\([0-9]*:\)\?[0-9]\+[^0-9]*\(M\)/\2/'`
	#echo svnver: $v
	#echo current: $current
	#echo modif: $modif

	if [[ $modif == M ]]; then
		current=$[$current + 1];
	fi
#else
#	v=`$1/dev-tools/getsvnrev $1`
#	if [ "$v" = "0" ]; then
#		exit 0;
#	fi
#	if ! expr "$v" : '[0-9]\+$' > /dev/null; then
#		echo "Error: Unable to get SVN Revision!";
#		exit 0;
#	fi
#	if [ -z "$v" ]; then
#                echo "Error: Unable to get SVN Revision!";
#                exit 0;
#	fi
#	current="$v"
#fi

filever=`grep TINNS_SVN_REVISION $2 | sed 's/^.*"\([0-9]\+\)".*$/\1/'`
#echo svnver in file: $filever

if [[ $filever -ge $current ]]; then
	echo No SVN Revision number change needed
	exit 0;
fi

echo Updating SVN Revision number to $current

cat >$2 <<ENDOFDOC
/*
	TinNS (TinNS is not a Neocron Server)
	Copyright (C) 2005 Linux Addicted Community
	maintainer Akiko <akiko@gmx.org>

	This program is free software; you can redistribute it and/or
	modify it under the terms of the GNU General Public License
	as published by the Free Software Foundation; either version 2
	of the License, or (at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program; if not, write to the Free Software
	Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
	02110-1301, USA.
*/

/*
	THIS FILE IS GENERATED BY THE MAKE COMMAND make svnrev
	It is to be updated by this command before each revision commit operation
	PLEASE DON'T MODIFY BY HAND
*/

#ifndef SVN_REV_DEF
#define SVN_REV_DEF

#define TINNS_SVN_REVISION "$current"

#endif

ENDOFDOC

